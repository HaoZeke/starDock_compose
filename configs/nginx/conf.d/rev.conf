upstream portainer {
    server portainer:9000;
}

upstream php {
    server php:9000;
}

upstream plex {
    server plex:32400;
}

upstream plexpy {
    server plexpy:8181;
}

upstream ombi {
    server ombi:3579;
}

upstream jackett {
    server jackett:9117;
}

upstream radarr {
    server radarr:7878;
}

upstream sonarr {
    server sonarr:8989;
}

upstream transmission {
    server transmission:9091;
}

upstream caliweb {
    server caliweb:8083;
}

server {
  listen 80 default_server;

  root /www/Dashboard;
  index index.html index.htm index.php;

  client_max_body_size 0;

  location ~ \.php$ {
      fastcgi_split_path_info ^(.+\.php)(/.+)$;
      #Include Nginxâ€™s fastcgi configuration
      fastcgi_index index.php;
      include /etc/nginx/fastcgi.conf;
      #Look for the FastCGI Process Manager at this location
      fastcgi_pass php;
  }

  # Root location + organizr
  location / {
    if ($args ~ (.*)X-Plex-Device(.*)) {
        proxy_pass http://plex;
    }

    if ($http_referer ~ (.*)plex(.*)) {
        proxy_pass http://plex;
    }
    try_files $uri $uri/ /index.html /index.php?$args =404;
  }

  # Portainer
  location /portainer/ {
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_pass http://portainer/;
  }
  location /portainer/api/websocket/ {
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_http_version 1.1;
      proxy_pass http://portainer/api/websocket/;
  }

  # Plex
  location ~ ^/(\?(?:.*)(X-Plex-Device=)|web|video|photo|library|web|status|system|updater|clients|:|playQueues)(.*) {
      proxy_pass http://plex;
      proxy_redirect  http://plex /;
      # set some headers and proxy stuff.
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_redirect off;

      # include Host header
      proxy_set_header Host $host;

      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_read_timeout 36000s;
      proxy_pass_request_headers on;
  }

  location /plex {
      error_log /var/log/nginx/plex.error.log debug;
      rewrite_log on;
      rewrite ^/plex(.*)$ /web$1 break;
      proxy_pass http://plex;
      proxy_headers_hash_max_size 51200;
      proxy_headers_hash_bucket_size 6400;
      proxy_set_header X-Forwarded-for $proxy_add_x_forwarded_for;
      proxy_set_header Host $host;
      include proxy_params;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_read_timeout 36000s;
      proxy_pass_request_headers on;
  }

  # Plexpy
  location /plexpy {
      proxy_pass http://plexpy;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Host $server_name;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_read_timeout 90;
      proxy_set_header X-Forwarded-Proto $scheme;
      set $xforwardedssl "off";
      if ($scheme = https) {
              set $xforwardedssl "on";
      }
      proxy_set_header X-Forwarded-Ssl $xforwardedssl;
      proxy_redirect ~^(http(?:s)?://)([^:/]+)(?::\d+)?(/.*)?$ $1$2:$server_port$3;
  }

  # Ombi
  location /ombi {
      proxy_pass http://ombi;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Host $server_name;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Ssl on;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_read_timeout  90;
      proxy_redirect http://ombi https://$host;
  }
  if ($http_referer ~* /ombi/) {
          rewrite ^/dist/([0-9\d*]).js /ombi/dist/$1.js last;
  }

  # Jackett
  location /jackett {
    proxy_pass http://jackett;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real_IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Ssl on;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
    proxy_redirect default;
  }

  # Sonarr
  location /sonarr {
    proxy_pass http://sonarr;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real_IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Ssl on;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
    proxy_redirect default;
  }

  # Radarr
  location /radarr {
    proxy_pass http://radarr;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real_IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Ssl on;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
    proxy_redirect default;
  }

  # Transmission
  location /transmission {
    proxy_pass http://transmission;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real_IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Ssl on;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
    proxy_redirect default;
  }

  # Calibre
  location /calibre {
    proxy_pass http://caliweb/;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host $server_name;
    proxy_set_header X-Scheme $scheme;
    proxy_set_header X-Script-Name /calibre;
  }

}